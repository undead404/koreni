name: CI/CD Pipeline
permissions:
  contents: read

on:
  push:
    branches:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version-file: .nvmrc

      - name: Install dependencies
        run: yarn --frozen-lockfile --prefer-offline

      - name: Install server dependencies
        run: yarn --frozen-lockfile --prefer-offline
        working-directory: src/server

      - name: Lint
        run: yarn lint

  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version-file: .nvmrc

      - name: Install dependencies
        run: yarn --frozen-lockfile --prefer-offline

      - name: Run tests
        run: yarn test

  populate-typesense:
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
      - deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version-file: .nvmrc

      - name: Install dependencies
        run: yarn --frozen-lockfile --prefer-offline

      - name: Populate Typesense
        run: yarn typesense:populate
        env:
          TYPESENSE_ADMIN_KEY: ${{ secrets.TYPESENSE_ADMIN_KEY }}
          NEXT_PUBLIC_TYPESENSE_HOST: ${{ vars.TYPESENSE_HOST }}

  build:
    runs-on: ubuntu-latest
    needs:
      - lint
      - test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version-file: .nvmrc
      - name: Install dependencies
        run: yarn --frozen-lockfile --prefer-offline

      - name: Build Next.js project
        run: yarn build
        env:
          NEXT_PUBLIC_BUGSNAG_API_KEY: ${{ vars.BUGSNAG_API_KEY }}
          NEXT_PUBLIC_GISCUS_REPO_ID: ${{ secrets.GISCUS_REPO_ID }}
          NEXT_PUBLIC_GISCUS_CATEGORY_ID: ${{ secrets.GISCUS_CATEGORY_ID }}
          NEXT_PUBLIC_GITHUB_OWNER: ${{ github.repository_owner }}
          NEXT_PUBLIC_GITHUB_REPO: ${{ github.repository }}
          NEXT_PUBLIC_POSTHOG_HOST: ${{ vars.POSTHOG_HOST }}
          NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.POSTHOG_KEY }}
          NEXT_PUBLIC_SITE: ${{ vars.SITE }}
          NEXT_PUBLIC_TYPESENSE_SEARCH_KEY: ${{ vars.TYPESENSE_SEARCH_KEY }}
          NEXT_PUBLIC_TYPESENSE_HOST: ${{ vars.TYPESENSE_HOST }}
          NODE_ENV: production

      # 3. Upload Artifacts
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: out

  build-api:
    runs-on: ubuntu-latest
    needs:
      - lint
      - test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version-file: .nvmrc

      - name: Install frontend dependencies
        run: yarn --frozen-lockfile --prefer-offline

      - name: Install API dependencies
        run: yarn --frozen-lockfile --prefer-offline
        working-directory: src/server

      - name: Build API project
        run: yarn build
        working-directory: src/server

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-dist
          path: src/server/dist

  deploy:
    runs-on: ubuntu-latest
    needs:
      - build
      - deploy-api
    steps:
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ vars.SERVER_IP }} >> ~/.ssh/known_hosts

      # --- Frontend Deploy ---
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Deploy Frontend Files
        run: |
          rsync -avz --no-o --no-g -e "ssh" --delete ./dist/ ${{ secrets.SSH_USERNAME }}@${{ vars.SERVER_IP }}:/var/www/html
          ssh ${{ secrets.SSH_USERNAME }}@${{ vars.SERVER_IP }} 'sudo chown -R ${{ secrets.SSH_USERNAME }}:www-data /var/www/html && sudo chmod -R 755 /var/www/html'

      - name: Reload Nginx
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ vars.SERVER_IP }} << 'EOF'
            # Restart Service
            sudo systemctl reload nginx
          EOF

  deploy-api:
    runs-on: ubuntu-latest
    needs: build-api
    steps:
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ vars.SERVER_IP }} >> ~/.ssh/known_hosts

      # --- Backend Deploy ---
      - name: Download backend source
        uses: actions/download-artifact@v4
        with:
          name: api-dist
          path: api-dist

      # 1. Verify manifest files exist before deploying (Safety Check)
      - name: Check for package.json
        run: |
          if [ ! -f ./api-dist/package.json ]; then
            echo "Error: package.json missing in artifact. Ensure build script copies it to dist."
            exit 1
          fi

      - name: Deploy Backend Source
        run: |
          # Ensure target directory exists
          ssh ${{ secrets.SSH_USERNAME }}@${{ vars.SERVER_IP }} 'mkdir -p /var/www/koreni-api'

          # Sync files
          rsync -avz --no-o --no-g -e "ssh" --delete ./api-dist/ ${{ secrets.SSH_USERNAME }}@${{ vars.SERVER_IP }}:/var/www/koreni-api

      - name: Configure Environment and Install Dependencies
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ vars.SERVER_IP }} << 'EOF'
            set -e
            cd /var/www/koreni-api
            
            # Write .env to the correct directory
            echo "PORT=4000" > .env
            echo "BUGSNAG_API_API_KEY=${{ secrets.BUGSNAG_API_API_KEY }}" >> .env
            echo "GITHUB_TOKEN=${{ secrets.IMPORT_TOKEN }}" >> .env
            echo "GITHUB_OWNER=${{ github.repository_owner }}" >> .env
            echo "GITHUB_REPO=${{ github.repository }}" >> .env
            echo "TURNSTILE_SECRET_KEY=${{ secrets.TURNSTILE_SECRET_KEY }}" >> .env
            echo "POSTHOG_KEY=${{ secrets.POSTHOG_KEY }}" >> .env
            echo "POSTHOG_HOST=${{ vars.POSTHOG_HOST }}" >> .env
            echo "NEXT_PUBLIC_SITE=${{ vars.SITE }}" >> .env
            echo "NODE_ENV=production" >> .env
            echo "VALID_API_KEYS=${{ vars.VALID_API_KEYS }}" >> .env

            # Install dependencies ON THE SERVER
            yarn install --frozen-lockfile --production --prefer-offline
            
            # Restart Service
            sudo systemctl restart koreni-api
          EOF
